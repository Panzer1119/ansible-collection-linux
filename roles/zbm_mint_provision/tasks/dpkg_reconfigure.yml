---
# ------------------------------------------------------------
# Ensure required packages exist
# ------------------------------------------------------------

- name: Ensure localization packages are installed
  ansible.builtin.apt:
    name:
      - locales
      - tzdata
      - keyboard-configuration
      - console-setup
  delegate_to: "{{ chroot_name }}"
  become: true

# ------------------------------------------------------------
# Locales (debconf-driven)
# ------------------------------------------------------------

- name: Preseed locales to generate
  ansible.builtin.debconf:
    name: locales
    question: locales/locales_to_be_generated
    value: "{{ mint_locales.generate | join(', ') }}"
    vtype: multiselect
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Preseed default system locale
  ansible.builtin.debconf:
    name: locales
    question: locales/default_environment_locale
    value: "{{ mint_locales.default }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Reconfigure locales non-interactively
  ansible.builtin.command: dpkg-reconfigure -f noninteractive locales
  delegate_to: "{{ chroot_name }}"
  become: true
  changed_when: false

# ------------------------------------------------------------
# Timezone (tzdata)
# ------------------------------------------------------------

- name: Preseed timezone
  ansible.builtin.debconf:
    name: tzdata
    question: tzdata/Areas
    value: "{{ mint_timezone.split('/')[0] }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Preseed timezone city
  ansible.builtin.debconf:
    name: tzdata
    question: tzdata/Zones/{{ mint_timezone.split('/')[0] }}
    value: "{{ mint_timezone.split('/')[1] }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Reconfigure tzdata non-interactively
  ansible.builtin.command: dpkg-reconfigure -f noninteractive tzdata
  delegate_to: "{{ chroot_name }}"
  become: true
  changed_when: false

# ------------------------------------------------------------
# Keyboard / Console
# ------------------------------------------------------------

- name: Preseed keyboard model
  ansible.builtin.debconf:
    name: keyboard-configuration
    question: keyboard-configuration/model
    value: "{{ mint_keyboard.model }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Preseed keyboard layout
  ansible.builtin.debconf:
    name: keyboard-configuration
    question: keyboard-configuration/layout
    value: "{{ mint_keyboard.layout }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Preseed console layout
  ansible.builtin.debconf:
    name: console-setup
    question: console-setup/layoutcode
    value: "{{ mint_keyboard.layout }}"
    vtype: select
  delegate_to: "{{ chroot_name }}"
  become: true

- name: Reconfigure keyboard and console non-interactively
  ansible.builtin.command: dpkg-reconfigure -f noninteractive keyboard-configuration console-setup
  delegate_to: "{{ chroot_name }}"
  become: true
  changed_when: false
...
