---
- name: Ensure we are in UEFI mode
  stat:
    path: /sys/firmware/efi/efivars
  register: efi_check
  failed_when: not efi_check.stat.exists

- name: Read /etc/os-release values
  ansible.builtin.command:
    argv:
      - python3
      - -c
      - |
          import json
          import shlex

          data = {}
          try:
              with open("/etc/os-release", "r", encoding="utf-8") as handle:
                  for line in handle:
                      line = line.strip()
                      if not line or line.startswith("#") or "=" not in line:
                          continue
                      key, value = line.split("=", 1)
                      if value:
                          try:
                              data[key] = shlex.split(value)[0]
                          except ValueError:
                              data[key] = value.strip().strip('"').strip("'")
                      else:
                          data[key] = ""
          except FileNotFoundError:
              pass

          print(json.dumps(data))
  register: os_release_json
  changed_when: false

- name: Parse /etc/os-release values
  ansible.builtin.set_fact:
    os_release_map: "{{ os_release_json.stdout | default('{}') | from_json }}"

- name: Derive zfs distro name from os-release
  ansible.builtin.set_fact:
    zfs_distro_name: "{{ os_release_map.get('ID', 'mint') }}"
  when: zfs_distro_name | default('') | length == 0

- name: Derive zfs distro version from os-release
  ansible.builtin.set_fact:
    zfs_distro_version: "{{ os_release_map.get('VERSION_ID', '22.2') }}"
  when: zfs_distro_version | default('') | length == 0

- name: Derive ubuntu codename from os-release
  ansible.builtin.set_fact:
    ubuntu_codename: "{{ os_release_map.get('UBUNTU_CODENAME', 'noble') }}"
  when: ubuntu_codename | default('') | length == 0

- name: Derive Mint codename from os-release
  ansible.builtin.set_fact:
    mint_codename: "{{ os_release_map.get('VERSION_CODENAME', 'zara') }}"
  when: mint_codename | default('') | length == 0

- name: Derive Mint version from os-release
  ansible.builtin.set_fact:
    # Mint version uses the full package version fallback.
    mint_version: "{{ os_release_map.get('VERSION_ID', '22.2.0') }}"
  when: mint_version | default('') | length == 0

- name: Configure APT proxy on Live ISO (optional)
  template:
    src: 90proxy.j2
    dest: /etc/apt/apt.conf.d/90proxy
    owner: root
    group: root
    mode: '0644'
  when: apt_proxy | default('') | length > 0

- name: Install provisioning tools on Live ISO
  apt:
    name: [ debootstrap, gdisk, zfsutils-linux, curl ]
    update_cache: false

- name: Derive partition device paths
  set_fact:
    boot_part_device: "{{ boot_disk }}{{ 'p' if (is_nvme | bool) else '' }}{{ boot_part_num }}"
    pool_part_device: "{{ pool_disk }}{{ 'p' if (is_nvme | bool) else '' }}{{ pool_part_num }}"

- name: Generate HostID
  command: zgenhostid -f 0x00bab10c
  args:
    creates: /etc/hostid
