---
- name: Install base system packages (Chroot)
  shell: |
    chroot {{ chroot_path }} apt update
    chroot {{ chroot_path }} apt install -y --no-install-recommends \
      linux-generic dosfstools zfs-initramfs zfsutils-linux curl efibootmgr etckeeper

- name: Snapshot after base installation
  community.general.zfs:
    name: "{{ pool_name }}/ROOT/{{ zfs_id }}@post-20-install-base"
    state: present

- name: Install Mint Keyring (Chroot)
  shell: |
    chroot {{ chroot_path }} apt install -y wget gnupg
    wget -qO {{ chroot_path }}/tmp/mintkey.deb {{ mint_keyring_url }}
    chroot {{ chroot_path }} dpkg -i /tmp/mintkey.deb

- name: Install Mint base packages (Chroot)
  shell: |
    chroot {{ chroot_path }} apt update
    chroot {{ chroot_path }} apt install -y --no-install-recommends \
      mint-info-cinnamon mint-meta-core mint-meta-codecs

- name: Copy Mint apt preferences (Chroot)
  copy:
    src: "{{ chroot_path }}/usr/share/linuxmint/mintsystem/apt/official-package-repositories.pref"
    dest: "{{ chroot_path }}/etc/apt/preferences.d"
    mode: '0644'
    remote_src: true

- name: Derive mint base-files version (ubuntu + mint version)
  set_fact:
    mint_base_files_version: "13ubuntu10mint{{ mint_version }}" #TODO Get the ubuntu string dynamically

- name: Install base files for Mint (Chroot)
  command:
    argv:
      - chroot
      - "{{ chroot_path }}"
      - apt
      - install
      - -y
      - --no-install-recommends
      - "base-files={{ mint_base_files_version }}"

- name: Snapshot after Mint base installation
  community.general.zfs:
    name: "{{ pool_name }}/ROOT/{{ zfs_id }}@post-21-install-mint-base"
    state: present

- name: Install Cinnamon desktop (Chroot)
  shell: |
    chroot {{ chroot_path }} apt update
    chroot {{ chroot_path }} apt install -y --no-install-recommends \
      mint-meta-cinnamon

- name: Snapshot after Mint cinnamon installation
  community.general.zfs:
    name: "{{ pool_name }}/ROOT/{{ zfs_id }}@post-22-install-mint-cinnamon"
    state: present

- name: Install display manager and switch (Chroot)
  shell: |
    chroot {{ chroot_path }} apt update
    chroot {{ chroot_path }} apt install -y --no-install-recommends \
      lightdm
    chroot {{ chroot_path }} dpkg-reconfigure lightdm

- name: Snapshot after lightdm installation
  community.general.zfs:
    name: "{{ pool_name }}/ROOT/{{ zfs_id }}@post-23-install-lightdm"
    state: present

- name: Install bloat packages (Chroot)
  shell: |
    chroot {{ chroot_path }} apt update
    chroot {{ chroot_path }} apt install -y --no-install-recommends \
      nemo \
      xed \
      xviewer \
      xreader \
      celluloid \
      rhythmbox \
      file-roller \
      gnome-terminal \
      gnome-system-monitor \
      gnome-screenshot \
      gnome-disk-utility \
      gnome-calculator \
      simple-scan \
      firefox \
      thunderbird \
      vlc \
      gimp \
      libreoffice \
      git \
      eza \
      iperf3 \
      screen \
      magic-wormhole

- name: Snapshot after bloat installation
  community.general.zfs:
    name: "{{ pool_name }}/ROOT/{{ zfs_id }}@post-24-install-bloat"
    state: present
...
