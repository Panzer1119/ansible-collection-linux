---
- name: (Chroot) Install tools needed for Mint keyring
  vars:
    _snap_post_21_install_mint_base_re: '(^|.*-)post-21-install-mint-base$'
    _snap_post_22_install_mint_cinnamon_re: '(^|.*-)post-22-install-mint-cinnamon$'
    _snap_post_23_install_lightdm_re: '(^|.*-)post-23-install-lightdm$'
    _snap_post_24_install_bloat_re: '(^|.*-)post-24-install-bloat$'
  ansible.builtin.apt:
    update_cache: true
    name:
      - wget
      - gnupg
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

- name: (Chroot) Download Mint keyring
  ansible.builtin.get_url:
    url: "{{ mint_keyring_url }}"
    dest: /tmp/mintkey.deb
    mode: "0644"
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

- name: (Chroot) Install Mint keyring package
  ansible.builtin.apt:
    deb: /tmp/mintkey.deb
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

# ------------------------------------------------------------

- name: (Chroot) Install Mint base packages
  ansible.builtin.apt:
    update_cache: true
    install_recommends: false
    name:
      - mint-info-cinnamon
      - mint-meta-core
      - mint-meta-codecs
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

- name: (Chroot) Copy Mint apt preferences
  ansible.builtin.copy:
    src: /usr/share/linuxmint/mintsystem/apt/official-package-repositories.pref
    dest: /etc/apt/preferences.d/official-package-repositories.pref
    mode: "0644"
    remote_src: true
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    apt_sources == 'official'
    and not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

- name: Derive mint base-files version (ubuntu + mint version)
  ansible.builtin.set_fact:
    mint_base_files_version: "13ubuntu10mint{{ mint_version }}" # TODO: derive dynamically

- name: (Chroot) Install Mint base-files package
  ansible.builtin.apt:
    update_cache: true
    install_recommends: false
    name: "base-files={{ mint_base_files_version }}"
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_21_install_mint_base_re) | list | length) > 0)

- name: Snapshot after Mint base installation
  ansible.builtin.command:
    argv:
      - zfs
      - snapshot
      - -r
      - "{{ pool_name }}@{{ lookup('pipe', 'date -u +%Y-%m-%d-%H%M%S') }}-post-21-install-mint-base"
    state: present

# ------------------------------------------------------------

- name: (Chroot) Install Cinnamon desktop meta package
  ansible.builtin.apt:
    update_cache: true
    install_recommends: false
    name:
      - mint-meta-cinnamon
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_22_install_mint_cinnamon_re) | list | length) > 0)

- name: Snapshot after Mint cinnamon installation
  ansible.builtin.command:
    argv:
      - zfs
      - snapshot
      - -r
      - "{{ pool_name }}@{{ lookup('pipe', 'date -u +%Y-%m-%d-%H%M%S') }}-post-22-install-mint-cinnamon"
    state: present

# ------------------------------------------------------------

- name: (Chroot) Preseed LightDM as default display manager
  ansible.builtin.debconf:
    name: lightdm
    question: shared/default-x-display-manager
    value: lightdm
    vtype: select
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_23_install_lightdm_re) | list | length) > 0)

- name: (Chroot) Install LightDM
  ansible.builtin.apt:
    update_cache: true
    install_recommends: false
    name:
      - lightdm
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_23_install_lightdm_re) | list | length) > 0)

- name: Snapshot after lightdm installation
  ansible.builtin.command:
    argv:
      - zfs
      - snapshot
      - -r
      - "{{ pool_name }}@{{ lookup('pipe', 'date -u +%Y-%m-%d-%H%M%S') }}-post-23-install-lightdm"
    state: present

# ------------------------------------------------------------

- name: (Chroot) Install desktop applications ("bloat")
  ansible.builtin.apt:
    update_cache: true
    install_recommends: false
    name:
      - nemo
      - xed
      - xviewer
      - xreader
      - celluloid
      - rhythmbox
      - file-roller
      - gnome-terminal
      - gnome-system-monitor
      - gnome-screenshot
      - gnome-disk-utility
      - gnome-calculator
      - simple-scan
      - firefox
      - thunderbird
      - vlc
      - gimp
      - libreoffice
      - git
      - eza
      - iperf3
      - screen
      - magic-wormhole
    state: present
  delegate_to: "{{ chroot_path }}"
  become: true
  when: >-
    not ((zfs_snapshots | default([]) | select('match', _snap_post_24_install_bloat_re) | list | length) > 0)

- name: Snapshot after bloat installation
  ansible.builtin.command:
    argv:
      - zfs
      - snapshot
      - -r
      - "{{ pool_name }}@{{ lookup('pipe', 'date -u +%Y-%m-%d-%H%M%S') }}-post-24-install-bloat"
    state: present
...
