---
- name: Ensure registry data directories exist
  file:
    path: "{{ registry_data_base_path }}/{{ registry.name }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop: "{{ registries }}"
  loop_control:
    loop_var: registry

- name: Ensure ACME cache directories exist
  file:
    path: "{{ letsencrypt_cache_base_path }}/{{ registry.name }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop: "{{ registries }}"
  loop_control:
    loop_var: registry

- name: Generate config files for each registry
  template:
    src: registry-config.yml.j2
    dest: "{{ registry_data_base_path }}/{{ registry.name }}/config.yml"
  loop: "{{ registries }}"
  loop_control:
    loop_var: registry

- name: List all containers with the label for this role
  docker_host_info:
    containers: yes
    containers_filters:
      label: "de.panzer1119.ansible.role=set_up_docker_registry_mirror_vm"
  register: existing_registry_containers

- set_fact:
    desired_registry_names: "{{ registries | map(attribute='name') | list }}"

- name: Remove orphaned registry containers
  docker_container:
    name: "{{ item.Names[0] | regex_replace('^/', '') }}"
    state: absent
    force_kill: yes
  loop: "{{ existing_registry_containers.containers }}"
  when: (item.Names[0] | regex_replace('^/', '')) not in desired_registry_names

- name: Pull Docker Registry image
  docker_image:
    name: registry
    tag: "3"
    source: pull

- name: Deploy registry containers
  docker_container:
    name: "{{ registry.name }}"
    hostname: "{{ registry.name }}"
    image: registry:3
    restart_policy: always
    env:
      OTEL_TRACES_EXPORTER: "none"
    ports:
      - "{{ registry.port }}:5000"
    volumes:
      - "{{ registry_data_base_path }}/{{ registry.name }}:/var/lib/registry"
      - "{{ registry_data_base_path }}/{{ registry.name }}/config.yml:/etc/docker/registry/config.yml:ro"
      - "{{ letsencrypt_cache_base_path }}/{{ registry.name }}:/acme"
    labels:
      - "de.panzer1119.ansible.role=set_up_docker_registry_mirror_vm"
  loop: "{{ registries }}"
  loop_control:
    loop_var: registry
...
